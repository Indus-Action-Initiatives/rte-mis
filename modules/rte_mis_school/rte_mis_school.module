<?php

/**
 * @file
 * Contains rte_mis_school.module.
 */

use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\taxonomy\Entity\Term;
use Drupal\user\UserInterface;

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function rte_mis_school_user_presave(UserInterface $user) {
  // Get the UDISE code based on the selected UDISE term id.
  if ($mail = $user->getEmail()) {
    $user->setUsername($mail);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function rte_mis_school_form_user_login_form_alter(&$form, FormStateInterface $form_state) {
  $form['name']['#title'] = t('Username');
}

/**
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function rte_mis_school_inline_entity_form_entity_form_alter(&$form, FormStateInterface $form_state) {
  // Validate if the field exists or not in the form before doing any changes.
  if (array_key_exists('field_school_name', $form)) {
    $form['field_school_name']['widget'][0]['value']['#attributes']['readonly'] = 'readonly';
  }

  if (array_key_exists('field_udise_code', $form)) {
    $form['#prefix'] = '<div id="form-ajax-wrapper">';
    $form['#suffix'] = '</div>';

    $form['field_udise_code']['widget']['#ajax'] = [
      'callback' => 'rte_mis_school_populate_school_name',
      'wrapper' => 'form-ajax-wrapper',
      'event' => 'select2:select',
      'method' => 'replace',
      'progress' => [
        'type' => 'throbber',
        'message' => t('Searching School Name...'),
      ],
    ];

    // Add the udise code cache tag so that we get the updated list of UDISE
    // code everytime any changes occurs in the vocab.
    $form['#cache']['tags'] = array_merge($form['#cache']['tags'] ?? [], ['taxonomy_term_list:school_udise_code']);
  }
}

/**
 * Callback function to populate the school name based on UDISE code.
 */
function rte_mis_school_populate_school_name(array $form, FormStateInterface $form_state) {
  // @todo Need to add proper validations here.
  // Get the UDISE code term value.
  $target_id = $form_state->getValue('field_school_details')[0]['inline_entity_form']['field_udise_code'];

  if (!empty($target_id) && $target_id[0]['value'] !== '_none') {
    // Load the term and get the School name.
    $term = Term::load($target_id[0]['value']);
    $school_name = $term->get('field_school_name')->getString();
    $form['field_school_details']['widget'][0]['inline_entity_form']['field_school_name']['widget'][0]['value']['#value'] = $school_name;
  }
  else {
    $form['field_school_details']['widget'][0]['inline_entity_form']['field_school_name']['widget'][0]['value']['#value'] = '';
  }

  return $form['field_school_details']['widget'][0]['inline_entity_form'];
}

/**
 * Callback function to provide the list of approved UDISE code.
 */
function rte_mis_school_udise_list(FieldStorageConfig $definition, ContentEntityInterface $entity = NULL, $cacheable) {
  // Load all the approved UDISE terms.
  $terms = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadByProperties([
    'vid' => 'school_udise_code',
    'field_workflow' => 'school_udise_code_workflow_approved',
  ]);

  $options = [
    '_none' => '- None -',
  ];
  foreach ($terms as $term) {
    if ($term instanceof Term) {
      $options[$term->id()] = $term->label();
    }
  }

  return $options;
}

/**
 * Callback function to provide the list of multiple fields.
 */
function rte_mis_school_default_field_options(FieldStorageDefinitionInterface $definition, FieldableEntityInterface $entity = NULL, &$cacheable = TRUE) {
  $options = [];
  // Get the field name.
  $field_name = $definition->getName();
  if (in_array($field_name, ['field_aid_status', 'field_minority_status'])) {
    // Get the field name with option defined.
    $config = \Drupal::config('rte_mis_school.settings')->get('field_default_options');
    $defined_options = $config[$field_name] ?? NULL;
    if (isset($defined_options)) {
      $options = $defined_options;
    }
  }
  return $options;

}

/**
 * Implements hook_local_tasks_alter().
 */
function rte_mis_school_local_tasks_alter(&$local_tasks) {
  // Alter the destination query parameter for delete local task in taxonomy.
  if ($local_tasks['entity.taxonomy_term.delete_form']) {
    $local_tasks['entity.taxonomy_term.delete_form']['class'] = '\Drupal\rte_mis_school\Plugin\Menu\AlterTaxonomyLocalTask';
  }
}
